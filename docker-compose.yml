version: '3'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - NODE_ENV=production
    image: kitan-verify-frontend:latest
    container_name: kitan-verify-frontend
    environment:
      - VITE_CLOUDFLARE_SITE_KEY=${VITE_CLOUDFLARE_SITE_KEY}
      - VITE_BACKEND_URL=/api  # Change backend URL to relative URL
    volumes:
      - ./nginx/ssl:/etc/nginx/ssl

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        - PYTHON_BASE=3.10-slim
    image: kitan-verify-backend:latest
    container_name: kitan-verify-backend
    environment:
      - SERVER_HOST=0.0.0.0  # Change to 0.0.0.0 ,so it's accessible inside Docker network
      - SERVER_PORT=${SERVER_PORT}
      - MONGO_URI=mongodb://mongo:27017/your-database
      - CLOUDFLARE_SECRET_KEY=${CLOUDFLARE_SECRET_KEY}
      - VERIFY_DOMAIN=${VERIFY_DOMAIN}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/cf.conf:/etc/nginx/cf.conf:ro
    environment:
      - NGINX_SERVER_NAME=${NGINX_SERVER_NAME}
      - SSL_CERTIFICATE_PATH=${SSL_CERTIFICATE_PATH}
      - SSL_CERTIFICATE_KEY_PATH=${SSL_CERTIFICATE_KEY_PATH}

  mongo:
    image: mongo:latest
    container_name: kitan_verify_mongo
    volumes:
      - mongo-data:/data/db

volumes:
  mongo-data: